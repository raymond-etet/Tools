# =================================================================================
# Clash.Meta ä¼˜åŒ–ç‰ˆé…ç½® for [OpenWrt + AdGuard Home + OpenClash] - GeoIPç‰ˆ
#
# ä¼˜åŒ–å†…å®¹:
# 1. ç¦ç”¨IPv6 DNSè§£æï¼Œè§£å†³"ip version error"
# 2. å¯ç”¨GEOSITE/GEOIPæ”¯æŒï¼Œä½¿ç”¨CDNåŠ é€Ÿä¸‹è½½
# 3. ä½¿ç”¨åœ°ç†æ•°æ®åº“è§„åˆ™ç®€åŒ–é…ç½®
# 4. ä¼˜åŒ–DNSé…ç½®ï¼Œæå‡ç¨³å®šæ€§
# =================================================================================

# --- ç«¯å£è®¾ç½® (ä¿æŒåŸæœ‰é…ç½®) ---
port: 7890
socks-port: 7891
mixed-port: 7893
redir-port: 7892
tproxy-port: 7895

# --- åŸºç¡€è®¾ç½® ---
allow-lan: true
bind-address: "*"
mode: rule
external-controller: 0.0.0.0:9090 # å…è®¸å¤–éƒ¨è®¿é—®
secret: "" # ç©ºå¯†é’¥ï¼Œæ— éœ€éªŒè¯
log-level: warning # å‡å°‘æ—¥å¿—è¾“å‡ºæå‡æ€§èƒ½

# --- DNS é…ç½® (ä¿®å¤ç‰ˆ) ---
dns:
  enable: true
  listen: 0.0.0.0:7874
  ipv6: false # ä¿®å¤: ç¦ç”¨IPv6é¿å…DNSè§£æé”™è¯¯
  prefer-h3: false # ä¿®å¤: ç¦ç”¨HTTP/3é¿å…åè®®é”™è¯¯
  use-hosts: true
  respect-rules: true
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter:
    - "*.lan"
    - "*.local"
    - "*.localdomain"
    - "+.stun.*.*"
    - "+.stun.*.*.*"
    - "+.stun.*.*.*.*"
    - "+.stun.*.*.*.*.*"
    - "*.msftconnecttest.com"
    - "*.msftncsi.com"
    - "msftconnecttest.com"
    - "msftncsi.com"

  # å›½å†… DNS - ä½¿ç”¨æ›´ç¨³å®šçš„IPv4 DNS
  default-nameserver:
    - 223.5.5.5 # é˜¿é‡ŒDNS
    - 119.29.29.29 # è…¾è®¯DNS
    - 114.114.114.114 # 114DNS
    - 8.8.8.8 # Google DNS (å¤‡ç”¨)

  # å›½å¤– DNS - ä½¿ç”¨ä¼ ç»ŸDNSé¿å…DoHé—®é¢˜
  nameserver:
    - 223.5.5.5 # é˜¿é‡ŒDNS
    - 119.29.29.29 # è…¾è®¯DNS
    - 8.8.8.8 # Google DNS
    - 1.1.1.1 # Cloudflare DNS

  # ä»£ç†DNS (ç®€åŒ–é…ç½®é¿å…è¿æ¥é—®é¢˜)
  proxy-server-nameserver:
    - 8.8.8.8
    - 1.1.1.1

  # ä½¿ç”¨geositeè§„åˆ™é…ç½®DNSç­–ç•¥
  nameserver-policy:
    "geosite:cn": ["223.5.5.5", "119.29.29.29"]
    "geosite:private": ["system"]
    "+.cn": ["223.5.5.5", "119.29.29.29"]
    "+.local": ["system"]
    # å¸¸è§å›½å†…åŸŸååç¼€ç›´æ¥ä½¿ç”¨å›½å†…DNS
    "+.com.cn": ["223.5.5.5", "119.29.29.29"]
    "+.net.cn": ["223.5.5.5", "119.29.29.29"]
    "+.org.cn": ["223.5.5.5", "119.29.29.29"]
    "+.gov.cn": ["223.5.5.5", "119.29.29.29"]

  # å¯ç”¨geoipè¿‡æ»¤å™¨
  fallback-filter:
    geoip: true # å¯ç”¨geoipè¿‡æ»¤
    geoip-code: CN # ä¸­å›½å¤§é™†IPä½¿ç”¨å›½å†…DNS
    ipcidr: ["240.0.0.0/4", "0.0.0.0/32", "127.0.0.1/32"]
    domain:
      [
        "+.google.com",
        "+.facebook.com",
        "+.youtube.com",
        "+.github.com",
        "+.githubusercontent.com",
      ]

# --- æµé‡æ¢æµ‹ Sniffer (ä¿®å¤ç‰ˆ) ---
sniffer:
  enable: true
  parse-pure-ip: true
  override-destination: true
  sniff:
    TLS:
      ports: [443, 8443]
    HTTP:
      ports: [80, 8080-8880]
  skip-domain:
    - "*.lan"
    - "*.local"
    # è·³è¿‡å›½å†…åŸŸåå—…æ¢
    - "geosite:cn"
    - "*.cn"
    - "*.com.cn"
    - "*.net.cn"
    - "*.org.cn"

# --- çŠ¶æ€ä¸ç¼“å­˜ ---
profile:
  store-selected: true
  store-fake-ip: true

# --- ä»£ç†èŠ‚ç‚¹ (ä¿æŒåŸæœ‰) ---

# --- åˆ†æµè§„åˆ™ (GeoIPç‰ˆ - å¤§é™†é¦™æ¸¯ç›´è¿ï¼Œå…¶ä»–èµ°ä»£ç†) ---
rules:
  # æœ¬åœ°ç½‘ç»œç›´è¿
  - DOMAIN-SUFFIX,local,DIRECT
  - DOMAIN-SUFFIX,localhost,DIRECT
  - DOMAIN-SUFFIX,lan,DIRECT
  - IP-CIDR,127.0.0.0/8,DIRECT
  - IP-CIDR,10.0.0.0/8,DIRECT
  - IP-CIDR,172.16.0.0/12,DIRECT
  - IP-CIDR,192.168.0.0/16,DIRECT
  - IP-CIDR,169.254.0.0/16,DIRECT

  # è‡ªå®šä¹‰ç›´è¿åŸŸå
  # - DOMAIN-SUFFIX,pc528.net,DIRECT
  # - DOMAIN-SUFFIX,pc521.net,DIRECT

  # ä¸­å›½å¤§é™†åŸŸåå’ŒIPç›´è¿ (ä½¿ç”¨GeoSiteå’ŒGeoIP)
  - GEOSITE,cn,DIRECT
  - GEOSITE,private,DIRECT
  - GEOIP,cn,DIRECT

  # é¦™æ¸¯IPç›´è¿ (ä½¿ç”¨GeoIP)
  - GEOIP,hk,DIRECT

  # ä¸­å›½å¤§é™†å¸¸è§åŸŸååç¼€ç›´è¿
  - DOMAIN-SUFFIX,cn,DIRECT
  - DOMAIN-SUFFIX,com.cn,DIRECT
  - DOMAIN-SUFFIX,net.cn,DIRECT
  - DOMAIN-SUFFIX,org.cn,DIRECT
  - DOMAIN-SUFFIX,gov.cn,DIRECT
  - DOMAIN-SUFFIX,edu.cn,DIRECT

  # å›½å¤–çŸ¥åæœåŠ¡èµ°ä»£ç† (ç¡®ä¿ä¸è¢«ä¸Šé¢è§„åˆ™è¯¯åˆ¤)
  - GEOSITE,google,ğŸš€ èŠ‚ç‚¹é€‰æ‹©
  - GEOSITE,github,ğŸš€ èŠ‚ç‚¹é€‰æ‹©
  - GEOSITE,youtube,ğŸš€ èŠ‚ç‚¹é€‰æ‹©
  - GEOSITE,facebook,ğŸš€ èŠ‚ç‚¹é€‰æ‹©
  - GEOSITE,twitter,ğŸš€ èŠ‚ç‚¹é€‰æ‹©
  - GEOSITE,telegram,ğŸš€ èŠ‚ç‚¹é€‰æ‹©
  - GEOSITE,netflix,ğŸš€ èŠ‚ç‚¹é€‰æ‹©

  # å…¶ä»–æ‰€æœ‰æµé‡èµ°ä»£ç†
  - MATCH,ğŸš€ èŠ‚ç‚¹é€‰æ‹©

# --- æ€§èƒ½ä¼˜åŒ– (é’ˆå¯¹ OpenWrt ç¯å¢ƒ) ---
tcp-concurrent: true # TCPå¹¶å‘è¿æ¥ï¼šå¯ç”¨å¤šè·¯å¤ç”¨ï¼Œæé«˜ç½‘ç»œè¿æ¥æ•ˆç‡ï¼Œå‡å°‘å»¶è¿Ÿ
udp-idle-timeout: 60 # UDPç©ºé—²è¶…æ—¶ï¼šUDPè¿æ¥ç©ºé—²60ç§’åè‡ªåŠ¨æ–­å¼€ï¼Œé‡Šæ”¾èµ„æº
keep-alive-idle: 600 # TCP Keep-Aliveç©ºé—²æ—¶é—´ï¼š600ç§’åå‘é€ä¿æ´»åŒ…æ£€æµ‹è¿æ¥çŠ¶æ€
keep-alive-interval: 15 # TCP Keep-Aliveé—´éš”ï¼šæ¯15ç§’å‘é€ä¸€æ¬¡ä¿æ´»æ¢æµ‹åŒ…

# --- ç½‘ç»œä¼˜åŒ– (ä¿®å¤ç‰ˆ) ---
interface-name: "" # ç»‘å®šç½‘ç»œæ¥å£ï¼šç•™ç©ºè¡¨ç¤ºè‡ªåŠ¨é€‰æ‹©ï¼Œå¯æŒ‡å®šå…·ä½“ç½‘å¡åç§°(å¦‚eth0)
routing-mark: 0 # è·¯ç”±æ ‡è®°ï¼šç”¨äºLinux iptablesæ ‡è®°æ•°æ®åŒ…ï¼Œ0è¡¨ç¤ºä¸è®¾ç½®æ ‡è®°

# --- å®éªŒæ€§åŠŸèƒ½ (OpenClash å…¼å®¹) ---
experimental:
  unified-delay: true # ç»Ÿä¸€å»¶è¿Ÿæµ‹è¯•ï¼šä½¿ç”¨ç»Ÿä¸€çš„å»¶è¿Ÿæµ‹è¯•æ–¹æ³•ï¼Œæé«˜æµ‹è¯•å‡†ç¡®æ€§
  ignore-resolve-fail: true # å¿½ç•¥DNSè§£æå¤±è´¥ï¼šå½“DNSè§£æå¤±è´¥æ—¶ç»§ç»­è¿è¡Œï¼Œæå‡ç¨³å®šæ€§
  cache-file: /tmp/clash.db # ç¼“å­˜æ–‡ä»¶è·¯å¾„ï¼šå­˜å‚¨DNSå’Œè¿æ¥ç¼“å­˜çš„æ–‡ä»¶ä½ç½®
  cache-size: 100000 # ç¼“å­˜æ¡ç›®æ•°é‡ï¼šæœ€å¤šç¼“å­˜10ä¸‡æ¡DNSè®°å½•ï¼Œå……åˆ†åˆ©ç”¨8GBå†…å­˜
  cache-ttl: 3600 # ç¼“å­˜ç”Ÿå­˜æ—¶é—´ï¼šç¼“å­˜è®°å½•ä¿å­˜1å°æ—¶(3600ç§’)ï¼Œå‡å°‘DNSæŸ¥è¯¢é¢‘ç‡

# --- æ•…éšœå¤„ç†ä¸é‡è¯•ç­–ç•¥ ---
find-process-mode: strict # è¿›ç¨‹æŸ¥æ‰¾æ¨¡å¼ï¼šä¸¥æ ¼æ¨¡å¼ï¼Œç²¾ç¡®åŒ¹é…è¿›ç¨‹ä¿¡æ¯ç”¨äºæµé‡åˆ†æ
global-ua: ClashMetaForAndroid/2.8.9.Meta # å…¨å±€User-Agentï¼šä¼ªè£…ä¸ºAndroidç‰ˆClashå®¢æˆ·ç«¯
global-client-fingerprint: chrome # å…¨å±€TLSæŒ‡çº¹ï¼šä¼ªè£…ä¸ºChromeæµè§ˆå™¨çš„TLSæ¡æ‰‹ç‰¹å¾

# --- åœ°ç†æ•°æ®åº“é”™è¯¯å¤„ç† ---
geo-auto-fallback: true # åœ°ç†æ•°æ®åº“è‡ªåŠ¨é™çº§ï¼šä¸»æ•°æ®æºå¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®æº
geo-lazy-load: false # åœ°ç†æ•°æ®åº“æ‡’åŠ è½½ï¼šç¦ç”¨å»¶è¿ŸåŠ è½½ï¼Œå¯åŠ¨æ—¶å®Œæ•´åŠ è½½é¿å…è¿è¡Œæ—¶é”™è¯¯

# --- åœ°ç†æ•°æ®åº“é…ç½® (ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç‰ˆ) ---
geodata-mode: true # åœ°ç†æ•°æ®æ¨¡å¼ï¼šå¯ç”¨åŸºäºåœ°ç†ä½ç½®çš„è·¯ç”±è§„åˆ™åŒ¹é…
geodata-loader: memconservative # åœ°ç†æ•°æ®åŠ è½½å™¨ï¼šå†…å­˜ä¿å®ˆæ¨¡å¼ï¼Œå¹³è¡¡å†…å­˜ä½¿ç”¨å’Œæ€§èƒ½
geo-auto-update: false # åœ°ç†æ•°æ®è‡ªåŠ¨æ›´æ–°ï¼šç¦ç”¨è‡ªåŠ¨æ›´æ–°ï¼Œä½¿ç”¨OpenClashé¢„è£…çš„æœ¬åœ°æ–‡ä»¶

# ä½¿ç”¨OpenClashè‡ªå¸¦çš„æœ¬åœ°åœ°ç†æ•°æ®åº“æ–‡ä»¶
# OpenClashä¼šè‡ªåŠ¨ä½¿ç”¨ /usr/share/openclash/ ç›®å½•ä¸‹çš„æœ¬åœ°æ–‡ä»¶
# ä¸éœ€è¦é…ç½® geox-url å’Œ geox-fallback-urlï¼Œè®©ç³»ç»Ÿä½¿ç”¨é»˜è®¤æœ¬åœ°è·¯å¾„
